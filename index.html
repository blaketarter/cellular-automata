<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body>
  <canvas id="canvas" height="400" width="400"></canvas>
  <script src="dist/bundle.js"></script>
  <script>
    const canvasEle = document.getElementById('canvas');

    const CELLS = {
      'air': {
        color: '#ffffff',
      },
      'rock': {
        color: '#000000',
      },
      'water': {
        color: '#3060ff'
      },
      'lava': {
        color: '#FF4500'
      }
    };

    const OPTIONS = {
      rows: 25,
      columns: 25,
      cellSize: 25,
    };

    function generation(worldInstance, count, limit, stepCb, endCb, timeout) {
      if (count <= limit) {
        setTimeout(function() {
          worldInstance.step();
          stepCb(worldInstance);
          generation(worldInstance, ++count, limit, stepCb, endCb, timeout);
        }, timeout);
      } else {
        endCb(worldInstance);
      }
    }

    const world = new window.CA.World({
      rows: OPTIONS.rows,
      columns: OPTIONS.columns,
    });

    // world.addAgent('air', { wasAlive: false, isAlive: false });
    world.addAgent('rock', { isAlive: true });

    world.addRule((agent, neighbors) => {
      const existingNeighbors = neighbors.filter(agent => agent);
      const aliveNeighbors = existingNeighbors.filter(agent => agent.isAlive);

      if (agent.type !== 'rock') {
        return agent;
      }

      if (existingNeighbors.length < 8) {
        return { ...agent, isAlive: true, };
      }

      if (aliveNeighbors.length > 4) {
        return { ...agent, isAlive: true, };
      }

      if (aliveNeighbors.length < 3) {
        return { ...agent, isAlive: false, };
      }

      return agent;
    });

    world.fillWithDistribution([{
      agent: 'rock',
      chance: 0.65,
      state: { isAlive: false, },
    }, {
      agent: 'rock',
      chance: 0.35,
      state: { isAlive: true, },
    }]);

    console.log(world);

    const map = new window.CA.GameMap(canvasEle);
    console.log(map);

    function render() {
      map.renderWorld(world, OPTIONS.cellSize, cell => {
        switch (cell.type) {
          case 'rock':
            if (cell.isAlive) {
              return CELLS['rock'];
            }

            return CELLS['air'];
        }

        if (CELLS[cell.type]) {
          return CELLS[cell.type];
        }
      });
    }

    render();

    generation(world, 0, 10, render, () => {
      world.addAgent('water');
      world.addAgent('lava');

      world.replaceWithDistribution([{
        agent: 'water',
        match: (cell) => !cell.isAlive,
        chance: 0.5,
      }, {
        agent: 'lava',
        match: (cell) => cell.isAlive,
        chance: 0.25,
      }]);

      render();
    }, 250);
  </script>
</body>

</html>
